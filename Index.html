<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç­ç´šåº§ä½è¡¨ç”¢ç”Ÿå™¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f8;
      color: #222;
    }
    header {
      padding: 16px 24px;
      background: #3949ab;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }
    header .subtitle {
      font-size: 13px;
      opacity: 0.85;
    }
    main {
      padding: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }
    .panel {
      background: #fff;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    #left-panel {
      flex: 1 1 320px;
      max-width: 380px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    #right-panel {
      flex: 2 1 420px;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    h2 {
      margin: 0 0 8px;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    h3 {
      margin: 0 0 6px;
      font-size: 14px;
      font-weight: 600;
    }
    .section {
      margin-bottom: 10px;
    }
    label {
      font-size: 13px;
      display: block;
      margin-bottom: 4px;
    }
    textarea {
      width: 100%;
      min-height: 90px;
      resize: vertical;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 13px;
      font-family: inherit;
    }
    input[type="text"], select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 13px;
      font-family: inherit;
    }
    input[type="file"] {
      font-size: 13px;
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      background: #3949ab;
      color: #fff;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.15s ease, transform 0.05s ease;
    }
    button.secondary {
      background: #e0e0e0;
      color: #333;
    }
    button.danger {
      background: #e53935;
    }
    button:hover {
      background: #303f9f;
    }
    button.secondary:hover {
      background: #d5d5d5;
    }
    button.danger:hover {
      background: #c62828;
    }
    button:active {
      transform: scale(0.97);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .hint {
      font-size: 11px;
      color: #666;
      margin-top: 2px;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #e8eaf6;
      color: #3949ab;
    }
    #student-count {
      font-size: 12px;
      color: #555;
    }
    .student-pool {
      min-height: 80px;
      border-radius: 8px;
      border: 1px dashed #bbb;
      padding: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      background: #fafafa;
    }
    .student-item {
      padding: 4px 8px;
      border-radius: 999px;
      background: #fff;
      border: 1px solid #c5cae9;
      font-size: 12px;
      cursor: grab;
      user-select: none;
      white-space: nowrap;
    }
    .student-item:active {
      cursor: grabbing;
    }
    .student-item span.remove {
      margin-left: 6px;
      font-size: 11px;
      cursor: pointer;
      color: #b71c1c;
    }

    .config-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
      align-items: flex-end;
    }
    .config-row > div {
      flex: 1 1 120px;
    }
    .mode-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
    }

    #seat-grid-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #view-info {
      font-size: 12px;
      color: #555;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    #seat-grid {
      background: #fdfdfd;
      border-radius: 12px;
      padding: 12px;
      border: 1px solid #e0e0e0;
      display: grid;
      gap: 8px;
      justify-content: center;
    }
    .seat {
      width: 80px;
      min-height: 48px;
      border-radius: 10px;
      border: 1px solid #c5cae9;
      background: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 4px;
      font-size: 12px;
      text-align: center;
      position: relative;
    }
    .seat.empty {
      background: #fafafa;
      border-style: dashed;
      color: #aaa;
    }
    .seat-label {
      position: absolute;
      top: 3px;
      left: 4px;
      font-size: 10px;
      color: #999;
    }
    .seat-name {
      padding: 0 4px;
      word-break: break-all;
    }
    .seat-remove {
      position: absolute;
      top: 3px;
      right: 4px;
      font-size: 11px;
      cursor: pointer;
      color: #b71c1c;
    }
    .seat.drag-over {
      border-color: #3949ab;
      box-shadow: 0 0 0 2px rgba(57,73,171,0.2);
    }

    .legend {
      font-size: 11px;
      color: #666;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .legend span.box {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 3px;
      background: #fff;
      border: 1px solid #c5cae9;
      margin-right: 3px;
    }
    .legend span.box.empty {
      background: #fafafa;
      border-style: dashed;
    }

    @media (max-width: 900px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      #left-panel {
        max-width: none;
      }
      .seat {
        width: 72px;
      }
    }
  </style>
  <!-- è®€å– Excel å°ˆç”¨ï¼šSheetJS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
  <header>
    <div>
      <h1>ç­ç´šåº§ä½è¡¨äº’å‹•å·¥å…·</h1>
      <div class="subtitle">æ‰‹å‹•è¼¸å…¥ï¼Excel åå–®åŒ¯å…¥ã€éš¨æ©Ÿæ’åº§ã€æ‰‹å‹•æ‹–æ›³ã€æ–¹å‘åˆ‡æ›ä¸€æ¬¡æå®š</div>
    </div>
    <div id="student-count">ç›®å‰å­¸ç”Ÿï¼š<span id="student-count-number">0</span> äºº</div>
  </header>

  <main>
    <section id="left-panel" class="panel">
      <div class="section">
        <h2>1. å»ºç«‹å­¸ç”Ÿåå–® <span class="tag">å¿…å¡«</span></h2>
        <h3>æ‰‹å‹•è¼¸å…¥</h3>
        <label for="manual-names">æ¯è¡Œä¸€å€‹å­¸ç”Ÿå§“åï¼ˆå¯è²¼ä¸Šåº§è™Ÿï¼‹å§“åï¼Œç³»çµ±æœƒç›´æ¥ä½¿ç”¨æ•´è¡Œæ–‡å­—ï¼‰</label>
        <textarea id="manual-names" placeholder="01 ç‹å°æ˜&#10;02 è¬å°åŸ&#10;03 é™³æ€¡å®‰&#10;04 æ—ä½³ç©&#10;05 å¼µå®‡æ™¨&#10;06 åŠ‰å­ç¿”&#10;07 é»ƒå“ç¿&#10;08 å³å®¥è“&#10;09 è¨±åº­ç‘‹&#10;10 è”¡å­Ÿæ¨º&#10;11 æ¥Šæ‰¿ç¿°&#10;12 æ´ªæµšå–†&#10;13 é„­é›…ç²&#10;14 éƒ­æŸä»»&#10;15 é‚±å“å¦¤&#10;16 èŠäºˆæ©&#10;17 æ›¾å½¥å»·&#10;18 è•­ç­±æ™´&#10;19 é‚µå»ºè±ª&#10;20 å»–å¿ƒé€¸&#10;21 è‘‰å† å»·&#10;22 é¡ç­ åº­&#10;23 æ–¹æ˜€æ½”&#10;24 é¾å­ç‘œ&#10;25 è˜‡å©•å¦¤&#10;26 å½­å®¥ä¸&#10;27 é«˜é–æ©&#10;28 åŒ…æ¬å¦®"></textarea>
        <div class="btn-row">
          <button id="add-manual-btn">åŠ å…¥åå–®</button>
          <button id="clear-students-btn" class="secondary">æ¸…ç©ºæ‰€æœ‰å­¸ç”Ÿ</button>
        </div>
        <div class="hint">æç¤ºï¼šé‡è¤‡åŠ å…¥æ™‚æœƒè‡ªå‹•å¿½ç•¥å®Œå…¨ç›¸åŒçš„åç¨±ã€‚</div>
      </div>

      <div class="section">
        <h3>å¾ Excel åŒ¯å…¥</h3>
        <label for="excel-file">é¸æ“‡ .xlsx æª”æ¡ˆï¼ˆç¬¬ä¸€å€‹å·¥ä½œè¡¨ã€ç¬¬ä¸€æ¬„è¦–ç‚ºå§“åï¼‰</label>
        <input type="file" id="excel-file" accept=".xlsx,.xls" />
        <div class="btn-row">
          <button id="import-excel-btn" class="secondary">è®€å– Excel ä¸¦åŠ å…¥åå–®</button>
        </div>
        <div class="hint">è«‹å°‡å­¸ç”Ÿå§“åæ”¾åœ¨ç¬¬ä¸€æ¬„ï¼Œç©ºç™½åˆ—æœƒè‡ªå‹•ç•¥éã€‚</div>
      </div>

      <div class="section">
        <h3>æœªå®‰æ’åº§ä½çš„å­¸ç”Ÿ</h3>
        <div id="student-pool" class="student-pool" aria-label="æœªå®‰æ’åº§ä½å­¸ç”Ÿï¼Œæ‹–æ›³åˆ°åº§ä½å³å¯">å°šæœªå»ºç«‹åå–®</div>
        <div class="hint">æ‹–æ›³å­¸ç”Ÿåˆ°åº§ä½ä¸Šå³å¯æ‰‹å‹•æŒ‡å®šåº§ä½ï¼›åˆªé™¤åœ–ç¤ºå¯æŠŠåº§ä½ä¸Šçš„å­¸ç”Ÿæ”¾å›é€™è£¡ã€‚</div>
      </div>
    </section>

    <section id="right-panel" class="panel">
      <div class="section">
        <h2>2. åº§ä½è¨­å®š & æ’åº§æ–¹å¼</h2>
        <div class="config-row">
          <div>
            <label for="seat-pattern">åº§ä½æ ¼å±€</label>
            <select id="seat-pattern">
              <option value="5x6">5 åˆ— Ã— 6 è¡Œï¼ˆå‰å¾Œ 5 æ’ï¼‰</option>
              <option value="6x5">6 åˆ— Ã— 5 è¡Œï¼ˆå‰å¾Œ 6 æ’ï¼‰</option>
            </select>
            <div class="hint">åˆ— = å¾è¬›å°åˆ°å¾Œé¢ä¸€æ’æ’ï¼›è¡Œ = æ•™å¸«è¦–è§’çš„å·¦å³ã€‚</div>
          </div>
          <div>
            <label for="view-direction">é¡¯ç¤ºæ–¹å‘</label>
            <select id="view-direction">
              <option value="teacher">å¾è¬›å°çœ‹ä¸‹å»</option>
              <option value="student">å¾å­¸ç”Ÿåº§ä½çœ‹å‘é»‘æ¿</option>
            </select>
            <div class="hint">åªæ”¹è®Šé¡¯ç¤ºé †åºï¼Œä¸æ”¹è®Šå¯¦éš›åº§è™Ÿã€‚</div>
          </div>
        </div>

        <div class="mode-row">
          <div style="flex:1 1 160px;">
            <label for="assign-mode">æ’åº§æ¨¡å¼</label>
            <select id="assign-mode">
              <option value="by-list">ä¾åå–®é †åºï¼ˆåº§è™Ÿé †ï¼‰</option>
              <option value="random">å®Œå…¨éš¨æ©Ÿ</option>
              <option value="reverse">é¡›å€’ç›®å‰åº§ä½ï¼ˆå‰å¾Œå°èª¿ï¼‰</option>
              <option value="mirror">å·¦å³å°èª¿ï¼ˆé¡åƒï¼‰</option>
              <option value="rotate">å¾€å‰è¼ªä¸€æ’</option>
            </select>
          </div>
          <div class="btn-row">
            <button id="apply-layout-btn">å¥—ç”¨æ’åº§</button>
            <button id="clear-layout-btn" class="secondary">å…¨éƒ¨åº§ä½æ¸…ç©º</button>
          </div>
        </div>
        <div class="hint">å‰å…©ç¨®æ¨¡å¼æœƒé‡æ–°å®‰æ’æ‰€æœ‰å­¸ç”Ÿï¼›å¾Œä¸‰ç¨®æ¨¡å¼æ˜¯å°ç›®å‰åº§ä½åšè®Šæ›ã€‚</div>
      </div>

      <div id="seat-grid-wrapper">
        <div id="view-info">
          <div>
            <strong>3. åº§ä½è¡¨</strong>
            <span id="view-label" style="margin-left:6px;font-size:12px;color:#666;">å°šæœªå»ºç«‹åº§ä½æ ¼å±€</span>
          </div>
          <div class="legend">
            <span><span class="box"></span> æœ‰å­¸ç”Ÿ</span>
            <span><span class="box empty"></span> ç©ºä½</span>
          </div>
        </div>
        <div id="seat-grid"></div>
        <div class="hint">å°æé†’ï¼šé»ä¸€ä¸‹åº§ä½ä¸­çš„ã€ŒÃ—ã€å¯æŠŠè©²ç”Ÿç§»å›æœªå®‰æ’å€ã€‚</div>
      </div>
    </section>
  </main>

  <script>
    // ç‹€æ…‹è³‡æ–™
    let students = []; // { id: string, name: string }
    let layout = {
      rows: 5,
      cols: 6,
      seats: [] // å­˜ studentId æˆ– null
    };

    const studentPoolEl = document.getElementById('student-pool');
    const studentCountNumberEl = document.getElementById('student-count-number');
    const seatPatternEl = document.getElementById('seat-pattern');
    const viewDirectionEl = document.getElementById('view-direction');
    const assignModeEl = document.getElementById('assign-mode');
    const seatGridEl = document.getElementById('seat-grid');
    const viewLabelEl = document.getElementById('view-label');

    const manualNamesEl = document.getElementById('manual-names');
    const addManualBtn = document.getElementById('add-manual-btn');
    const clearStudentsBtn = document.getElementById('clear-students-btn');
    const excelFileInput = document.getElementById('excel-file');
    const importExcelBtn = document.getElementById('import-excel-btn');

    const applyLayoutBtn = document.getElementById('apply-layout-btn');
    const clearLayoutBtn = document.getElementById('clear-layout-btn');

    function updateStudentCount() {
      studentCountNumberEl.textContent = students.length;
    }

    function getStudentById(id) {
      return students.find(s => s.id === id) || null;
    }

    function studentIsSeated(id) {
      return layout.seats.includes(id);
    }

    function refreshStudentPool() {
      studentPoolEl.innerHTML = '';
      if (students.length === 0) {
        studentPoolEl.textContent = 'å°šæœªå»ºç«‹åå–®';
        return;
      }
      const unseated = students.filter(s => !studentIsSeated(s.id));
      if (unseated.length === 0) {
        studentPoolEl.textContent = 'ç›®å‰æ‰€æœ‰å­¸ç”Ÿçš†å·²å®‰æ’åº§ä½';
        return;
      }
      unseated.forEach(s => {
        const div = document.createElement('div');
        div.className = 'student-item';
        div.draggable = true;
        div.dataset.id = s.id;
        div.textContent = s.name;

        const removeSpan = document.createElement('span');
        removeSpan.className = 'remove';
        removeSpan.textContent = 'Ã—';
        removeSpan.title = 'å¾åå–®ç§»é™¤';
        removeSpan.addEventListener('click', (e) => {
          e.stopPropagation();
          removeStudentCompletely(s.id);
        });
        div.appendChild(removeSpan);

        div.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('text/plain', s.id);
        });
        studentPoolEl.appendChild(div);
      });
    }

    function removeStudentCompletely(id) {
      layout.seats = layout.seats.map(seatId => seatId === id ? null : seatId);
      students = students.filter(s => s.id !== id);
      updateStudentCount();
      refreshStudentPool();
      renderSeatGrid();
    }

    function ensureLayoutSize(rows, cols) {
      const total = rows * cols;
      const oldSeats = layout.seats || [];
      const newSeats = new Array(total).fill(null);
      for (let i = 0; i < Math.min(total, oldSeats.length); i++) {
        newSeats[i] = oldSeats[i];
      }
      layout.rows = rows;
      layout.cols = cols;
      layout.seats = newSeats;
    }

    function parsePattern(pattern) {
      const [r, c] = pattern.split('x').map(v => parseInt(v, 10));
      return { rows: r || 5, cols: c || 6 };
    }

    function renderSeatGrid() {
      const rows = layout.rows;
      const cols = layout.cols;
      seatGridEl.innerHTML = '';
      seatGridEl.style.gridTemplateColumns = `repeat(${cols}, auto)`;

      const direction = viewDirectionEl.value;
      let labelText = direction === 'teacher' ? 'å¾è¬›å°çœ‹ â†’ ä¸Šæ–¹ç‚ºå‰æ’' : 'å¾å­¸ç”Ÿåº§ä½çœ‹ â†’ ä¸Šæ–¹ç‚ºå¾Œæ’';
      viewLabelEl.textContent = `${labelText}ï¼ˆ${rows} åˆ— Ã— ${cols} è¡Œï¼‰`;

      const seatsFragment = document.createDocumentFragment();
      for (let vr = 0; vr < rows; vr++) {
        for (let vc = 0; vc < cols; vc++) {
          let rowIndex, colIndex;
          if (direction === 'teacher') {
            rowIndex = vr;
            colIndex = vc;
          } else {
            rowIndex = rows - 1 - vr;
            colIndex = cols - 1 - vc;
          }
          const seatIndex = rowIndex * cols + colIndex;
          const studentId = layout.seats[seatIndex] || null;
          const seatEl = document.createElement('div');
          seatEl.className = 'seat' + (studentId ? '' : ' empty');
          seatEl.dataset.index = seatIndex.toString();
          seatEl.setAttribute('droppable', 'true');

          const label = document.createElement('div');
          label.className = 'seat-label';
          label.textContent = `${rowIndex + 1}-${colIndex + 1}`;
          seatEl.appendChild(label);

          const nameDiv = document.createElement('div');
          nameDiv.className = 'seat-name';
          if (studentId) {
            const stu = getStudentById(studentId);
            nameDiv.textContent = stu ? stu.name : '(æœªçŸ¥)';
            const remove = document.createElement('span');
            remove.className = 'seat-remove';
            remove.textContent = 'Ã—';
            remove.title = 'ç§»å›æœªå®‰æ’å€';
            remove.addEventListener('click', (e) => {
              e.stopPropagation();
              layout.seats[seatIndex] = null;
              refreshStudentPool();
              renderSeatGrid();
            });
            seatEl.appendChild(remove);
          } else {
            nameDiv.textContent = 'ç©ºä½';
          }
          seatEl.appendChild(nameDiv);

          seatEl.addEventListener('dragover', (e) => {
            e.preventDefault();
            seatEl.classList.add('drag-over');
          });
          seatEl.addEventListener('dragleave', () => {
            seatEl.classList.remove('drag-over');
          });
          seatEl.addEventListener('drop', (e) => {
            e.preventDefault();
            seatEl.classList.remove('drag-over');
            const id = e.dataTransfer.getData('text/plain');
            if (!id) return;
            placeStudentToSeat(id, seatIndex);
          });

          seatsFragment.appendChild(seatEl);
        }
      }
      seatGridEl.appendChild(seatsFragment);
    }

    function placeStudentToSeat(studentId, seatIndex) {
      layout.seats = layout.seats.map(id => id === studentId ? null : id);
      layout.seats[seatIndex] = studentId;
      refreshStudentPool();
      renderSeatGrid();
    }

    function clearAllSeats() {
      layout.seats = new Array(layout.rows * layout.cols).fill(null);
      refreshStudentPool();
      renderSeatGrid();
    }

    // ğŸ” é€™è£¡æ˜¯ã€Œé‡æ–°å¯«éã€çš„æ’åº§æ¨¡å¼ï¼ˆå«å®Œå…¨éš¨æ©Ÿï¼‰
    function applyAssignMode() {
      const mode = assignModeEl.value;
      const rows = layout.rows;
      const cols = layout.cols;
      const totalSeats = rows * cols;

      // ç¢ºä¿ seats é•·åº¦æ­£ç¢º
      if (!Array.isArray(layout.seats) || layout.seats.length !== totalSeats) {
        layout.seats = new Array(totalSeats).fill(null);
      }

      if (mode === 'by-list' || mode === 'random') {
        if (!Array.isArray(students) || students.length === 0) {
          // æ²’åå–®å°±ç›´æ¥ä¸åšäº‹ï¼ˆä¸å† alertï¼Œé¿å…è¢« iframe å¡ä½ï¼‰
          return;
        }

        // å…ˆä¾åå–®é †åºæ‹¿å‡ºå…¨éƒ¨å­¸ç”Ÿ id
        const ids = students.map(s => s.id);

        // å®Œå…¨éš¨æ©Ÿï¼šæ‰“äº‚é™£åˆ—
        if (mode === 'random') {
          ids.sort(() => Math.random() - 0.5);
        }

        // é‡æ–°å¡«å…¥åº§ä½
        layout.seats.fill(null);
        for (let i = 0; i < Math.min(ids.length, totalSeats); i++) {
          layout.seats[i] = ids[i];
        }
      } else if (mode === 'reverse') {
        // å‰å¾Œæ’å°èª¿ï¼šä»¥ row ç‚ºå–®ä½åè½‰
        const newSeats = new Array(totalSeats).fill(null);
        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            const fromIndex = r * cols + c;
            const toRow = rows - 1 - r;
            const toIndex = toRow * cols + c;
            newSeats[toIndex] = layout.seats[fromIndex];
          }
        }
        layout.seats = newSeats;
      } else if (mode === 'mirror') {
        // å·¦å³é¡åƒ
        const newSeats = new Array(totalSeats).fill(null);
        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            const fromIndex = r * cols + c;
            const toCol = cols - 1 - c;
            const toIndex = r * cols + toCol;
            newSeats[toIndex] = layout.seats[fromIndex];
          }
        }
        layout.seats = newSeats;
      } else if (mode === 'rotate') {
        // å¾€å‰è¼ªä¸€æ’ï¼šæ•´é«”å‘å‰ä½ç§»ä¸€æ•´ rowï¼ˆcols å€‹åº§ä½ï¼‰
        const shift = cols;
        const newSeats = new Array(totalSeats).fill(null);
        for (let i = 0; i < totalSeats; i++) {
          const toIndex = (i - shift + totalSeats) % totalSeats;
          newSeats[toIndex] = layout.seats[i];
        }
        layout.seats = newSeats;
      }

      refreshStudentPool();
      renderSeatGrid();
    }

    function addStudentsFromLines(lines) {
      const trimmed = lines
        .map(l => l.replace(/\r/g, '').trim())
        .filter(l => l.length > 0);
      if (trimmed.length === 0) return 0;

      let added = 0;
      trimmed.forEach(name => {
        const exists = students.some(s => s.name === name);
        if (!exists) {
          const id = 's_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 7);
          students.push({ id, name });
          added++;
        }
      });
      if (added > 0) {
        updateStudentCount();
        refreshStudentPool();
      }
      return added;
    }

    // äº‹ä»¶æ›è¼‰
    addManualBtn.addEventListener('click', () => {
      const text = manualNamesEl.value || '';
      const lines = text.split(/\n/);
      const added = addStudentsFromLines(lines);
      if (added === 0) {
        alert('æ²’æœ‰æ–°å¢ä»»ä½•å­¸ç”Ÿï¼ˆå¯èƒ½æ˜¯ç©ºç™½æˆ–å…¨éƒ¨å·²å­˜åœ¨ï¼‰ã€‚');
      }
    });

    clearStudentsBtn.addEventListener('click', () => {
      if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å­¸ç”Ÿèˆ‡åº§ä½å®‰æ’å—ï¼Ÿ')) return;
      students = [];
      layout.seats = new Array(layout.rows * layout.cols).fill(null);
      updateStudentCount();
      refreshStudentPool();
      renderSeatGrid();
    });

    importExcelBtn.addEventListener('click', () => {
      const file = excelFileInput.files && excelFileInput.files[0];
      if (!file) {
        alert('è«‹å…ˆé¸æ“‡ä¸€å€‹ Excel æª”æ¡ˆã€‚');
        return;
      }
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[firstSheetName];
          const sheetJson = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          const lines = [];
          sheetJson.forEach(row => {
            if (row && row[0] != null) {
              const cell = String(row[0]).trim();
              if (cell.length > 0) {
                lines.push(cell);
              }
            }
          });
          const added = addStudentsFromLines(lines);
          if (added === 0) {
            alert('Excel ä¸­æ²’æœ‰å¯æ–°å¢çš„å§“åï¼ˆå¯èƒ½æ˜¯ç©ºç™½æˆ–éƒ½å·²å­˜åœ¨ï¼‰ã€‚');
          } else {
            alert(`å·²å¾ Excel æ–°å¢ ${added} ä½å­¸ç”Ÿã€‚`);
          }
        } catch (err) {
          console.error(err);
          alert('è®€å– Excel æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚');
        }
      };
      reader.readAsArrayBuffer(file);
    });

    seatPatternEl.addEventListener('change', () => {
      const { rows, cols } = parsePattern(seatPatternEl.value);
      ensureLayoutSize(rows, cols);
      renderSeatGrid();
    });

    viewDirectionEl.addEventListener('change', () => {
      renderSeatGrid();
    });

    applyLayoutBtn.addEventListener('click', () => {
      applyAssignMode();
    });

    clearLayoutBtn.addEventListener('click', () => {
      if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰åº§ä½å®‰æ’å—ï¼Ÿ')) return;
      clearAllSeats();
    });

    // åˆå§‹åŒ–
    (function init() {
      const { rows, cols } = parsePattern(seatPatternEl.value);
      ensureLayoutSize(rows, cols);

      // é è¨­ç¤ºç¯„å­¸ç”Ÿåå–®
      const demoLines = [
        '01 ç‹å°æ˜',
        '02 è¬å°åŸ',
        '03 é™³æ€¡å®‰',
        '04 æ—ä½³ç©',
        '05 å¼µå®‡æ™¨',
        '06 åŠ‰å­ç¿”',
        '07 é»ƒå“ç¿',
        '08 å³å®¥è“',
        '09 è¨±åº­ç‘‹',
        '10 è”¡å­Ÿæ¨º',
        '11 æ¥Šæ‰¿ç¿°',
        '12 æ´ªæµšå–†',
        '13 é„­é›…ç²',
        '14 éƒ­æŸä»»',
        '15 é‚±å“å¦¤',
        '16 èŠäºˆæ©',
        '17 æ›¾å½¥å»·',
        '18 è•­ç­±æ™´',
        '19 é‚µå»ºè±ª',
        '20 å»–å¿ƒé€¸',
        '21 è‘‰å† å»·',
        '22 é¡ç­ åº­',
        '23 æ–¹æ˜€æ½”',
        '24 é¾å­ç‘œ',
        '25 è˜‡å©•å¦¤',
        '26 å½­å®¥ä¸',
        '27 é«˜é–æ©',
        '28 åŒ…æ¬å¦®'
      ];
      addStudentsFromLines(demoLines);

      updateStudentCount();
      refreshStudentPool();
      renderSeatGrid();
    })();
  </script>
</body>
</html>
